# System State: Atlas
> **AI Instruction:** This is the dynamic state of the project. Read this to synchronize your context with the current progress, active blockers, and the specific layer focus of the current session.

## 1. Current Mission
- **Objective:** MCPGateway MVP complete ✅ — ChatGPT connected to Atlas via MCP over Cloudflare
- **Primary Layer:** 02_Platform (`MCPGateway`)
- **Status:** MVP live and verified

---

## 2. Active Context & Contracts

### Infrastructure (Established)
- Pi IP: `192.168.178.76`
- Cloudflare Tunnel: `atlas-pi` (outbound-only, token in 1Password)
- Published routes:
  - `workout.linspad.net` → `http://192.168.178.76:8000`
  - `mcp.linspad.net`     → `http://192.168.178.76:8002`
- CF Zero Trust auth: Google OAuth, email whitelist `p.remmecke@gmail.com`
- Google OAuth Client: `home-oauth-476313` / `Cloudflare-Access-Linspad` (in 1Password)

### Auth Pattern (Confirmed)
**FastMCP `GoogleProvider`** — OAuth proxy to Google's own servers.

Flow:
```
ChatGPT → OAuth dance with Google (via FastMCP proxy endpoints)
        → Google issues token
        → ChatGPT sends token to mcp.linspad.net/mcp
        → FastMCP validates token via Google tokeninfo API
        → Tool call executed
```

No custom OAuth server code. FastMCP handles the full OAuth 2.1 dance.
The Google OAuth Client ID + Secret are the **same credentials** already used for
Cloudflare Access (or a separate one — TBD, see note below).

> ⚠️ **Note:** Cloudflare Access sits in front of mcp.linspad.net. With `GoogleProvider`,
> FastMCP needs to handle the OAuth redirect itself (e.g. `/.well-known/oauth-authorization-server`).
> CF Access will intercept those requests UNLESS the mcp.linspad.net Access policy is set to
> **bypass** for the OAuth metadata paths, OR a **dedicated Google OAuth client** is created for
> the MCP server (separate from the CF Access one). The simplest fix: create a separate Google
> OAuth client for FastMCP (free, takes 2 min in Google Cloud Console).

### MCP Tool Contract (MVP)
```
tool: get_fruit_color
input:  { "fruit": "apple" | "banana" | "mango" }
output: { "color": "red" | "yellow" | "orange" }
mapping (hardcoded): apple→red, banana→yellow, mango→orange
```

### Stack
| Concern | Choice |
|---|---|
| Framework | FastMCP (`pip install fastmcp`) |
| Auth | `fastmcp.server.auth.providers.google.GoogleProvider` |
| Transport | HTTP (`mcp.run(transport="http", host="0.0.0.0", port=8002)`) |
| Data | In-memory dict (no DB for MVP) |
| Container | Docker, port 8002 |
| Deploy | Pi, via Atlas Makefile |

### Folder Structure
```
03_Application/
  FoodTracker/
    MCPServer/
      app/
        main.py          ← FastMCP server + GoogleProvider + fruit tool
      Dockerfile
      compose.yml
    06_FoodTracker.md    ← App contract doc
```

### Makefile targets (01_System/Makefile additions)
```makefile
mcp-build, mcp-up, mcp-down, mcp-logs, mcp-reboot
```

### Secrets needed in secrets.env
```
GOOGLE_CLIENT_ID=...      # New Google OAuth client for FastMCP (separate from CF Access client)
GOOGLE_CLIENT_SECRET=...  # From Google Cloud Console → home-oauth-476313
MCP_BASE_URL=https://mcp.linspad.net
```

---

## 3. Short-Term Progress (The Event Stream)

| Date       | Event |
|------------|-------|
| 2026-02-21 | WorkoutTracker deployed to Pi via Cloudflare tunnel |
| 2026-02-22 | MCP Server project initiated. CF route `mcp.linspad.net → :8002` already active. |
| 2026-02-22 | Auth pattern confirmed: FastMCP `GoogleProvider`. |
| 2026-02-22 | MCPGateway moved to `02_Platform` (correct layer — serves multiple apps). |
| 2026-02-22 | **MVP verified** ✅ ChatGPT called `get_fruit_color("mango")` → `"orange"` via live Pi + Cloudflare tunnel. |

---

## 4. Known Blockers & Technical Debt

- **[LESSON]** FastMCP default redirect path is `/auth/callback` — register this in Google Cloud Console, NOT `/oauth/callback`.
- **[NEXT]** Replace hardcoded fruit→color dict with Postgres-backed food data when building real FoodTracker tools.

---

## 5. Human-in-the-Loop Flags

- [x] MCPGateway MVP working — ChatGPT calls `get_fruit_color` via Pi ✅
- [ ] Add real food/nutrition tools backed by Postgres for FoodTracker v1
